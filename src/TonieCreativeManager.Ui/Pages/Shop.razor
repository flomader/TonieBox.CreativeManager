@page "/shop"

@inject MediaService MediaService

@inject CreativeTonieService CreativeTonieService

@inject SessionService Session

@inject UserService UserService

@inject IHttpContextAccessor Accessor

<Header></Header>

@if (backPath != null)
{
    <a class="back mb-3" href="@backPath">Zurück</a>
}

<Grid Items="items" RestrictItemWidth="true"></Grid>

@code {

    IEnumerable<GridItem> items;

    string backPath;

    protected override async Task OnInitializedAsync()
    {
        var path = Accessor.HttpContext.Request.Query["path"].ToString();
        var mediaItems = await MediaService.GetItems(path);
        var canBuy = await UserService.CanBuyItem(Session.UserId);

        backPath = string.IsNullOrEmpty(path)
            ? null
            : $"/shop?path={path.GetParentPath().EncodeUrl()}";

        items = mediaItems
            .Where(item => item.HasSubitems || !item.HasBought)
            .Select(item =>
            {
                var restricted = !item.HasSubitems && !canBuy;
                var pathEncoded = item.Path.EncodeUrl();

                return new GridItem
                {
                    Name = item.Name,
                    Url = item.HasSubitems
                        ? $"/shop?path={pathEncoded}"
                        : restricted
                            ? null
                            : $"/shop/buy/confirm?path={pathEncoded}",
                    ImageUrl = $"/cover?path={pathEncoded}",
                    SubImageUrl = item.HasSubitems ? $"/cover?path=folder" : null,
                    SubImageClass = item.MappedTonieId != null ? "tonie" : null,
                    Restricted = restricted
                };
            })
            .ToArray();
    }

}