@page "/browse"

@inject MediaService MediaService 

@inject CreativeTonieService CreativeTonieService

@inject SessionService Session

@inject UserService UserService 

@inject IHttpContextAccessor Accessor

<Header BackUrl="@backPath"></Header>

<Grid Items="items" RestrictItemWidth="true"></Grid>

@code {

    IEnumerable<GridItem> items;

    string backPath;

    protected override async Task OnInitializedAsync()
    {
        var path = Accessor.HttpContext.Request.Query["path"].ToString();
        var mediaItems = await MediaService.GetItems(path);
        var tonies = await CreativeTonieService.GetTonies();
        var canUpload = await UserService.CanUploadItem(Session.UserId);

        backPath = string.IsNullOrEmpty(path)
            ? null
            : "javascript:history.back()";

        items = mediaItems
            .Where(item => item.HasBought)
            .Select(item =>
            {
                var pathEncoded = item.Path.EncodeUrl();
                var enabled = canUpload && item.MappedTonieId == null;

                return new GridItem
                {
                    Name = item.Name,
                    Url = enabled
                        ? item.HasSubitems
                            ? $"/browse?path={pathEncoded}"
                            : $"/upload/selecttonie?path={pathEncoded}"
                        : null,
                    ImageUrl = $"/cover?path={pathEncoded}",
                    SubImageUrl = item.HasSubitems
                         ? $"/cover?path=folder"
                         : item.MappedTonieId != null
                             ? tonies.FirstOrDefault(t => item.MappedTonieId == t.Id)?.ImageUrl
                             : null,
                    IsTonieSubImage = item.MappedTonieId != null,
                    Restricted = !enabled
                };
            })
            .ToArray();
    }

}